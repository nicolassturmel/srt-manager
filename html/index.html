<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My AES67 web test</title>
    <link rel="stylesheet" href="vumeter.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
</head>
<body>
<div id="container">
    <div id=player>
        <span id=playbtn></span>
        <span id=infos>Clic on a city name to play audio</span>
    </div>
    <div id=canada class="floating canada">
        <div class=dot></div>
        <div class=delay id=delayCanada></div>
        <div class=errors id=errorsCanada></div>
        <div class=name id="name-1">Toronto</div>
        <div class="vumeter left" ><div class=slider id=vumeterLeftCanada></div></div>
        <div class="vumeter right"><div class=slider id=vumeterRightCanada></div></div>
    </div>
    <div id=awsfran class="floating awsfran">
        <div class="dot aws"></div>
        <div class=name >AWS - Francfort</div>
    </div>
    <div id=germany class="floating germany">
        <div class=dot></div>
        <div class=delay id=delayGermany></div>
        <div class=errors id=errorsGermany></div>
        <div class=name id="name-3" >Germany</div>
        <div class="vumeter left" ><div class=slider id=vumeterLeftGermany></div></div>
        <div class="vumeter right"><div class=slider id=vumeterRightGermany></div></div>
    </div>
    <div id=france class="floating france">
        <div class=dot></div>
        <div class=delay id=delayFrance></div>
        <div class=errors id=errorsFrance></div>
        <div class=name id="name-0" >Grenoble</div>
        <div class="vumeter left" ><div class=slider id=vumeterLeftFrance></div></div>
        <div class="vumeter right"><div class=slider id=vumeterRightFrance></div></div>
    </div>
    <div id=switzerland class="floating switzerland">
        <div class=dot></div>
        <div class=delay id=delaySwitzerland></div>
        <div class=errors id=errorsSwitzerland></div>
        <div class=name id="name-2">Lausanne</div>
        <div class="vumeter left" ><div class=slider id=vumeterLeftSwitzerland></div></div>
        <div class="vumeter right"><div class=slider id=vumeterRightSwitzerland></div></div>
    </div>
</div>
<div id=datasee>show / hide debug data</div>
<div id=data class=hidden></div>
<script>

var bufferstats = [{},{},{},{},{},{}]
var bufferindex = 0
var packet_size = 48
var params = null

var topZero = (r) =>  r>100? 100 : (r>0? r : 0)

var idList = [
    "France",
    "Canada",
    "Switzerland",
    "Germany"
]

 window.onload = function() {

   var socketURL = 'ws://'+self.location.host+'/pcm';
   var socketURL2 = 'ws://'+self.location.host+'/stats';
   var player = null

   var startPlay = (sid) => {
       if(player) {
           player.destroy()
           player = null 
       }
       if(sid < 0) return
       player = new PCMPlayer({
            encoding: '32bitInt',
            channels: 2,
            sampleRate: 48000,
            flushingTime:2000
        });
        ws.send(JSON.stringify(
            {
                id: sid
            }
        ))
        console.log("Sending " + sid)

        idList.forEach((v,i) => document.getElementById("name-"+i).classList.remove("green"))
        
        document.getElementById("name-"+sid).classList.add("green")
    }

   
   document.getElementById("datasee").onclick = () => {
    if(data) {
        document.getElementById("data").classList.remove("hidden")
    }
    else {
        document.getElementById("data").classList.add("hidden")
    }
    data = !data
   }

   var ws = new WebSocket(socketURL);
    ws.binaryType = 'arraybuffer';
   // ws.onopen = () => document.getElementById("circle").classList.add("on")
   // ws.onclose = () => document.getElementById("circle").classList.remove("on")
    ws.addEventListener('message',function(event) {
        var data = new Uint8Array(event.data);
        console.log("Got DATA")
        if(player)
            player.feed(data);
    });

    let laststream = 0 
    
    var socketURL2 = 'ws://'+self.location.host+'/stats';
   var player = null

  

    idList.forEach((v,i) => document.getElementById("name-" + i).onclick = () => startPlay(i) )

    var ws2 = new WebSocket(socketURL2);
       ws2.addEventListener('message',function(event) {
            document.getElementById('data').innerHTML = event.data
            let gjj = JSON.parse(event.data)
            switch(gjj.type) {
                case "stats":
                    laststream = Date.now()
                    bufferstats[bufferindex] = gjj.data
                    bufferindex = (bufferindex + 1)%bufferstats.length
                    let jj = bufferstats[(bufferindex + 2)%bufferstats.length]
                    if(!jj.rms) return

                    let id = false
                    id = idList[gjj.data.id]
                    if(id) {
                        document.getElementById("delay" + id).innerHTML = parseInt(gjj.data.delay.mean/48)+"ms"
                        document.getElementById("vumeterLeft" + id).style.height = topZero(100+gjj.data.peak[0]*2) + "%"
                        document.getElementById("vumeterRight" + id).style.height = topZero(100+gjj.data.peak[1]*2) + "%"
                        document.getElementById("errors" + id).innerHTML = "Lost " + gjj.data.seqError + " packets"
                        if(gjj.data.seqError != 0)
                            document.getElementById("errors" + id).classList.add("red")
                        else
                            document.getElementById("errors" + id).classList.remove("red")
                    }
                    break;
                case "streams":
                    break;
                case "interfaces":
                    break
                case "params":
                    params = gjj.data
                    if(player) startPlay()
                    break
                default:
                    break;
            }
            
       });

 }   
</script>
<script type="text/javascript" src="../pcm-player.js"></script>
</body>
</html>
